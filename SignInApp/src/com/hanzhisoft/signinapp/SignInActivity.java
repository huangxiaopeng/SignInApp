package com.hanzhisoft.signinapp;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Date;import java.util.HashMap;import java.util.Map;import org.ksoap2.serialization.PropertyInfo;import com.baidu.location.BDLocation;import com.baidu.location.BDLocationListener;import com.baidu.location.LocationClient;import com.baidu.location.LocationClientOption;import com.baidu.location.LocationClientOption.LocationMode;import com.hanzhisoft.signinapp.R;import com.hanzhisoft.signinapp.data.SignInDataSource;import com.hanzhisoft.signinapp.data.SignRecord;import com.hanzhisoft.signinapp.user.UserDataSource;import com.hanzhisoft.signinapp.webservice.WsClient;import android.app.Activity;import android.content.SharedPreferences;import android.os.AsyncTask;import android.os.Bundle;import android.view.MenuItem;import android.view.View;import android.widget.Button;import android.widget.ImageView;import android.widget.ProgressBar;import android.widget.TextView;/** * @title: SignInActivity.java * @description: 签到页面 * @copyright: Copyright (c) 2014 * @company: HanZhiSoft * @author HuangXiaoPeng * @date 2014-12-7 * @version 1.0 */public class SignInActivity extends Activity {	private final String SIGN_IN_METHOD_NAME = "doSaveSigninInfo";	private final String URL = "http://115.28.91.8/axis2/services/SignInDao?wsdl";	private final String NAMESPACE = "http://dao.hzsignin.com";	public LocationClient locationClient;	public TextView currentLocation;	public ProgressBar pgb;	public TextView locationState;	public TextView locatingState;	public Button locaBtn;	public Button signBtn;	public TextView succssImg;	public SignInDataSource signInDataSource;	public UserDataSource userData;	public WsClient wsClient;	public String address;	// 签到参数	public String location_x;	public String location_y;	public String addrStr;	@Override	protected void onCreate(Bundle savedInstanceState) {		// TODO Auto-generated method stub		super.onCreate(savedInstanceState);		setContentView(R.layout.sign_in_layout);		initUI();		locationClient = new LocationClient(SignInActivity.this);		initLocationOptions(locationClient);		succssImg = (TextView) findViewById(R.id.success_sign);		userData = new UserDataSource(SignInActivity.this);		wsClient = new WsClient(URL, NAMESPACE);		signBtn.setEnabled(false);	}	private void initUI() {		currentLocation = (TextView) findViewById(R.id.currentLocation);		locationState = (TextView) findViewById(R.id.locationState);		pgb = (ProgressBar) findViewById(R.id.locationProgress);		locaBtn = (Button) findViewById(R.id.location_btn);		locatingState = (TextView) findViewById(R.id.locatingState);		signBtn = (Button) findViewById(R.id.signin_btn);		signBtn.setOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				signBtn.setEnabled(false);				signBtn.setText("正在签到，请稍候……");				SignInTask signTask = new SignInTask();				signTask.execute();			}		});		locaBtn.setOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				startLocation();			}		});	}	// start location	private void startLocation() {		succssImg.setVisibility(View.INVISIBLE);		locatingState.setVisibility(View.VISIBLE);		locationState.setVisibility(View.INVISIBLE);		locaBtn.setEnabled(false);		signBtn.setEnabled(false);		locationClient.start();		currentLocation.setVisibility(View.INVISIBLE);		pgb.setVisibility(View.VISIBLE);	}	@Override	public void onBackPressed() {		// TODO Auto-generated method stub		super.onBackPressed();	}	@Override	public boolean onOptionsItemSelected(MenuItem item) {		// Handle action bar item clicks here. The action bar will		// automatically handle clicks on the Home/Up button, so long		// as you specify a parent activity in AndroidManifest.xml.		int id = item.getItemId();		if (id == android.R.id.home) {			finish();		}		return super.onOptionsItemSelected(item);	}	public void initLocationOptions(LocationClient locationClient) {		LocationClientOption option = new LocationClientOption();		option.setLocationMode(LocationMode.Hight_Accuracy);// 设置定位模式		option.setCoorType("gcj02");// 返回的定位结果是百度经纬度，默认值gcj02		option.setScanSpan(1000);// 设置发起定位请求的间隔时间为5000ms		option.setIsNeedAddress(true); // 是否返回中文地址		locationClient.registerLocationListener(new HZSignLocationListener(				locationClient));		locationClient.setLocOption(option);	}	public class HZSignLocationListener implements BDLocationListener {		LocationClient locationClient;		public HZSignLocationListener(LocationClient locationClient) {			this.locationClient = locationClient;		}		@Override		public void onReceiveLocation(BDLocation location) {						String addr = location.getAddrStr();			currentLocation.setText(addr);			addrStr = addr;			location_x = location.getLongitude() + "";			location_y = location.getLatitude() + "";			locationClient.stop();			pgb.setVisibility(View.INVISIBLE);			currentLocation.setVisibility(View.VISIBLE);			locatingState.setVisibility(View.INVISIBLE);			locationState.setVisibility(View.VISIBLE);			locaBtn.setEnabled(true);			signBtn.setEnabled(true);			signBtn.setText("确认签到");		}	}	class SignInTask extends AsyncTask<String, String, String> {		private void saveLocation(String addr) {			signInDataSource = new SignInDataSource(SignInActivity.this);			SignRecord sr = new SignRecord();			sr.setSignId(System.currentTimeMillis() + "");			sr.setAddress(addr);			SimpleDateFormat dateFormat = new SimpleDateFormat(					"yyyy年MM月dd日 HH时mm分ss秒 E ");			sr.setSignTime(dateFormat.format(new Date()));			signInDataSource.addSignRecord(sr);		}		@Override		protected String doInBackground(String... args) {			String[] params = { "username", userData.getUser().getUserName(),					"location_x", location_x, "location_y", location_y,					"signaddress", addrStr };			String result = wsClient.getSoapObject(SIGN_IN_METHOD_NAME, params);			return result;		}		@Override		protected void onPostExecute(String result) {			if (!result.trim().equals("true")) {				succssImg.setText(result);			} else {				signBtn.setText("签到成功");				succssImg.setVisibility(View.VISIBLE);				saveLocation(addrStr);			}		}	}}